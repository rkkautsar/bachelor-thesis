version: v1.0
name: Initial Pipeline
agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu1804
blocks:
  - name: Install
    task:
      jobs:
        - name: texlive
          commands:
            - sudo apt-get update -q
            - sudo apt-get install -qy \
            - '    texlive-full \'
            - '    python-pygments gnuplot'
            - sudo rm -rf /var/lib/apt/lists/*
  - name: Compile
    task:
      prologue:
        commands:
          - checkout
          - git submodule init
          - git submodule update
      epilogue:
        always:
          commands:
            - checkout
            - git submodule deinit --force .
      jobs:
        - name: Make
          commands:
            - make
            - artifact push workflow --expire-in 2w out/thesis.pdf
promotions:
  - name: Upload if passed
    pipeline_file: pipeline_2.yml
    auto_promote:
      when: (branch = 'master' OR tag =~ '.*') AND result = 'passed'
