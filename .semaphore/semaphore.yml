version: v1.0
name: Initial Pipeline
agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu1804
  containers:
    - name: main
      image: 'blang/latex:ubuntu'
blocks:
  - name: Compile
    task:
      jobs:
        - name: Compile
          commands:
            - latexmk -pdf -shell-escape -outdir=out thesis.tex
            - artifact push workflow --expire-in 2w out/thesis.pdf
      prologue:
        commands:
          - checkout
          - git submodule init
          - git submodule update
      epilogue:
        always:
          commands:
            - checkout
            - git submodule deinit --force .
promotions:
  - name: Upload if passed
    pipeline_file: pipeline_2.yml
    auto_promote:
      when: (branch = 'master' OR tag =~ '.*') AND result = 'passed'
