version: v1.0
name: Initial Pipeline
agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu1804
  containers:
    - name: main
      image: 'raabf/latex-versions:texlive2019'
blocks:
  - name: Compile
    task:
      prologue:
        commands:
          - checkout
          - git submodule init
          - git submodule update
      epilogue:
        always:
          commands:
            - checkout
            - git submodule deinit --force .
        on_pass:
          commands:
            - 'git clone https://github.com/semaphoreci/toolbox.git ~/.toolbox'
            - '# Install binaries'
            - bash ~/.toolbox/install-toolbox
            - '# Source functions into current session'
            - source ~/.toolbox/toolbox
            - '# Add toolbox to your bash_profile to activate it in every SSH session'
            - echo 'source ~/.toolbox/toolbox' >> ~/.bash_profile
            - artifact push workflow --expire-in 1w out/thesis.pdf
      jobs:
        - name: Make
          commands:
            - apt-get update
            - apt-get install -y python
            - latexmk -pdf -shell-escape -file-line-error -halt-on-error -outdir=out thesis.tex
promotions:
  - name: Upload if passed
    pipeline_file: pipeline_2.yml
    auto_promote:
      when: (branch = 'master' OR tag =~ '.*') AND result = 'passed'
